# Amazon 商品信息抓取与上架优化方案（简版）

## 1. 目标与使用流程

### 使用流程
1. 用户在浏览器打开 Amazon 商品详情页
2. 点击浏览器插件按钮，一键采集当前页面商品信息
3. 插件自动跳转到后台管理页面（Next.js 应用）
4. 在后台查看采集的数据，使用 AI 优化功能生成更优质的 Listing

### 目标输出
- 商品结构化数据：标题、价格、图片、要点描述、详情、评分、评论摘要、关键词统计等  
- 基于数据分析生成的：优化标题、优化 Bullet Points、描述建议、图片布局建议  
- 用途：辅助运营生成更优质的上架信息（Listing）

---

## 2. 抓取方案选择对比

### Python 爬虫方案

- 核心技术栈：
  - `Playwright` 或 `Selenium`：支持动态渲染、反爬绕过、分页处理  
  - `BeautifulSoup4` / `lxml`：DOM 解析与数据提取  
  - `httpx` / `aiohttp`：异步 HTTP 请求（适用于简单页面）  
  - `playwright-stealth`：反检测插件  
- 优势：
  - Python 生态丰富，数据处理库（pandas、numpy）完善  
  - 与 FastAPI 后端无缝集成  
  - 使用 `uv` 进行快速依赖管理  
- 使用方式：
  - 编写针对 Amazon 的 DOM 解析逻辑（标题、图片、评论、要点等）  
  - 支持代理池、User-Agent 轮换、Cookie 管理等反爬策略  
- 结论：Python 爬虫成熟稳定，与数据分析和 AI 处理更契合

---

## 3. 基本架构设计

### 后端（FastAPI + Python + uv）

- 技术栈：
  - `FastAPI`：高性能异步 Web 框架，自动生成 API 文档  
  - `Playwright` / `Selenium`：浏览器自动化与页面抓取  
  - `uv`：超快速的 Python 包管理器（替代 pip/poetry）  
  - `Pydantic`：数据验证与序列化（FastAPI 内置）  
- 模块职责：
  - `抓取层`：用 Playwright 打开 Amazon 链接并提取原始数据  
  - `分析层`：基于原始数据做关键词统计、评论分析、Listing 优化建议  
  - `AI 层`（可选）：集成 LLM API 用于智能优化建议  
- 核心接口示例：
  - `GET /api/amazon/parse?url=...`
    - 打开页面 → 按规则提取数据 → 结构化返回
  - `ProductRawData` 数据模型（Pydantic）：
    - `title`, `price`, `images[]`, `bullets[]`, `description`, `rating`, `review_count`, `reviews[]`
- 项目初始化：
  ```bash
  uv init backend
  cd backend
  uv add fastapi uvicorn playwright playwright-stealth beautifulsoup4 pydantic
  playwright install chromium
  ```

### 前端（Next.js + MagicUI + Prisma）

- 技术栈：
  - `Next.js 14+`：React 框架（App Router）  
  - `MagicUI`：现代化 UI 组件库（动画、交互效果丰富）  
  - `TailwindCSS`：样式系统（MagicUI 基于此）  
  - `Prisma`：数据库 ORM，类型安全、开发体验好  
  - `React Query` / `SWR`：数据获取与缓存  
- 功能模块：
  - **商品列表**：展示所有采集的商品，支持搜索、筛选、分页  
  - **商品详情**：
    - 原始抓取数据（标题、图片轮播、评论摘要、关键词云）  
    - 使用 MagicUI 的动画组件展示数据加载与结果  
  - **优化建议**：
    - 生成的优化 Listing（标题、Bullet Points、描述建议等）  
    - 使用 MagicUI 的对比卡片组件展示原始 vs 优化  
  - **导出工具**：导出 JSON/CSV/Excel，方便上架或与其他工具对接

### 浏览器插件（Chrome Extension）

- 技术栈：
  - `Chrome Extension Manifest V3`：现代浏览器插件标准  
  - `TypeScript + React`：插件 popup 和侧边栏界面  
  - `Content Scrip + Prisma）

- 技术栈：
  - `PostgreSQL 15+`：开源关系型数据库，性能强大、功能丰富  
  - `Prisma`：现代化 ORM，类型安全、自动生成迁移、与 Next.js 完美集成  
- 数据存储设计：
  - **产品表**（Product）：商品基本信息（ASIN、URL、标题、价格、评分等）
  - **产品图片表**（ProductImage）：商品图片链接
  - **产品要点表**（ProductBullet）：Bullet Points
  - **评论表**（Review）：评论数据
  - **优化建议表**（Optimization）：AI 生成的优化建议
  - **抓取规则表**（ScrapingRule）：选择器规则配置
  - **用户表**（User）：用户账号和认证信息
- 连接配置示例：
  ```python
  # backend/database.py
  from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
  from sqlalchemy.orm import sessionmaker
  
  DATABASE_URL = "postgresql+asyncpg://user:password@localhost:5432/amazon_optimizer"
  
  engine = create_async_engine(DATABASE_URL, echo=True)
  async_session = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
  ```

---

## 4. DOM 变更应对策略（非 AI 自适应）

### 4.1 优先使用更稳定的数据源

- 尽量避免纯 CSS 结构定位  
- 优先从以下位置提取：
  - `JSON-LD` / `schema.org`（`<script type="application/ld+json">` 中的 `Product` 数据）  
  - `meta` 标签与 `data-*` 属性  
  - 带 `id` / `data-hook` / `aria-*` 等语义属性的元素

### 4.2 规则配置化与多候选 Selector

- 统一维护 `amazonSelectors` 配置，而不是在代码里分散写 selector  
- 每个字段允许多个候选 selector，按顺序尝试，并对结果做基本校验（如价格格式）  
- DOM 微调时，只需修改配置而非业务代码

### 4.3 文本/语义驱动定位

- 通过文本定位模块，例如先找到包含 “Customer reviews” 文本的区域，再在其下查找评分和评论数量  
- 避免依赖 `nth-child` 之类的脆弱路径选择器

### 4.4 健康检查与监控

- 维护一批固定 ASIN 作为测试样本  
- 定时任务定期抓取，校验关键字段是否完整/合理  
- 报警机制：
  - 连续失败或关键字段为空/异常即通知开发  
- 错误时记录 DOM 片段或截图，方便快速修复规则

### 4.5 抓取与优化解耦

- 抓取层只负责输出 `ProductRawData`  
- 优化层只消费结构化数据，与页面结构无关  
- DOM 变更时，只需修抓取层，优化逻辑保持不变

---

## 5. 引入 AI 的自适应规则更新流程

在上述“规则驱动”架构基础上，可以增加一层 AI 协助：

### 5.1 基本想法

- 正常流程：  
- **技术栈选型**：  
  - 前端：`Next.js 14+` + `MagicUI` + `TailwindCSS`  
    - 现代化、高性能、组件丰富、开发体验好  
  - 后端：`FastAPI` + `Playwright` + `uv`  
    - 异步高性能、Python 生态丰富、包管理快速  
  - 数据库：`PostgreSQL 15+`  
    - 开源关系型数据库，支持复杂查询、JSON 存储、全文搜索  
    - 使用 SQLAlchemy ORM 和 asyncpg 异步驱动  
- **抓取框架选型**：  
  - 使用 `Playwright`（Python 版本）+ 自定义 Amazon 解析逻辑  
  - 支持反爬策略：stealth 插件、代理池、User-Agent 轮换  
  - `uv` 快速管理依赖，提升开发效率  
- **数据持久化**：
  - 抓取的商品数据、评论、优化建议均存储在 PostgreSQL  
  - 支持历史数据查询、趋势分析、A/B 测试对比  
- **DOM 变动问题**：  
  - 通过结构化数据优先、规则配置化、多候选 selector、文本语义定位、监控与校验等手段，降低 DOM 变更带来的风险。  
- **AI 自适应方案**：  + `Prisma`  
    - 现代化、高性能、类型安全、开发体验好  
  - 浏览器插件：`Chrome Extension Manifest V3` + `TypeScript` + `React`  
    - 在 Amazon 商品页面一键采集数据，跳转到后台管理  
  - 后端：`FastAPI` + `Playwright` + `uv`（可选，用于批量爬取）  
    - 异步高性能、Python 生态丰富、包管理快速  
  - 数据库：`PostgreSQL 15+` + `Prisma`  
    - 关系型数据库 + 现代化 ORM，类型安全、自动迁移  
- **数据采集方式**：  
  - 主要：浏览器插件在前端直接提取页面数据（无需后端爬虫）  
  - 辅助：FastAPI + Playwright 用于批量抓取或定时任务  
- **数据持久化**：
  - 抓取的商品数据、评论、优化建议均存储在 PostgreSQL  
  - 使用 Prisma 管理数据模型和迁移，支持历史数据查询、趋势分析
cd backend

# 安装依赖
uv add fastapi uvicorn playwright playwright-stealth beautifulsoup4 pydantic python-multipart sqlalchemy asyncpg alembic psycopg2-binary

# 安装浏览器
playwright install chromium

# 设置数据库（确保已安装 PostgreSQL）
createdb amazon_optimizer

# 初始化数据库迁移
alembic init alembic
alembic revision --autogenerate -m "Initial schema"
alembic upgrade head

# 启动服务
uv run uvicorn main:app --reload --port 8000
```

### 前端启动
```bash
# 创建 Next.js 项目
npx 前端 + 数据库启动（主要开发）
```bash
# 创建 Next.js 项目
npx create-next-app@latest frontend --typescript --tailwind --app
cd frontend

# 安装依赖
npm install prisma @prisma/client magicui-react framer-motion lucide-react @tanstack/react-query

# 初始化 Prisma
npx prisma init

# 编辑 schema.prisma 定义数据模型后运行
npx prisma migrate dev --name init
npx prisma generate

# 启动开发服务器
npm run dev
```

### 浏览器插件开发
```bash
# 在 extension 目录下
cd extension
npm install
npm run build

# 在 Chrome 浏览器中加载插件：
# 1. 打开 chrome://extensions/
# 2. 开启"开发者模式"
# 3. 点击"加载已解压的扩展程序"，选择 extension/dist 目录
```

### 后端启动（可选，用于批量抓取）
```bash
# 使用 uv 创建项目
uv init backend
cd backend
uv add fastapi uvicorn playwright playwright-stealth beautifulsoup4 pydantic

# 安装浏览器并启动服务
playwright install chromium
uv run uvicorn main:app --reload --port 8000改规则配置；  
  - 更新配置后重试抓取，成功则记录并复用；  
  - 形成一个“规则驱动 + AI 辅助修复”的可持续抓取系统，用于长期支撑 Amazon 链接的商品分析与上架优化。